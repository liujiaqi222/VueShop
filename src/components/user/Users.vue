<template>
  <div>
    <!-- üçûÈù¢ÊùøÂ±ëÂØºËà™Âå∫Âüü -->
    <el-breadcrumb separator-class="el-icon-arrow-right">
      <el-breadcrumb-item :to="{ path: '/home' }">È¶ñÈ°µ</el-breadcrumb-item>
      <el-breadcrumb-item>Áî®Êà∑ÁÆ°ÁêÜ</el-breadcrumb-item>
      <el-breadcrumb-item>Ê¥ªÂä®ÂàóË°®</el-breadcrumb-item>
    </el-breadcrumb>
    <!-- ü™ßÂç°ÁâáËßÜÂõæÂå∫Âüü -->
    <el-card>
      <div>
        <!-- ÊêúÁ¥¢Âå∫Âüü -->
        <el-row :gutter="20">
          <!-- spanÊÄªÊï∞‰∏∫24 -->
          <el-col :xs="{ span: 24 }" :sm="{ span: 12 }">
            <el-input
              placeholder="ËØ∑ËæìÂÖ•ÂÜÖÂÆπ"
              class="input"
              v-model="queryInfo.query"
              clearable
              @clear="getUserList"
              @keyup.enter="getUserList"
            >
              <template #append>
                <el-button
                  icon="el-icon-search"
                  @click="getUserList"
                ></el-button>
              </template>
            </el-input>
          </el-col>
          <el-col :xs="{ span: 24 }" :sm="{ span: 4 }">
            <el-button type="primary" @click="dialogVisible = true"
              >Ê∑ªÂä†Áî®Êà∑</el-button
            >
          </el-col>
        </el-row>
      </div>
      <!-- Áî®Êà∑ÂàóË°®Âå∫Âüü -->
      <el-table :data="userList" stripe style="width: 100%" border>
        <el-table-column type="index" label="#"> </el-table-column>
        <el-table-column prop="username" label="ÂßìÂêçüòé"> </el-table-column>
        <el-table-column prop="email" label="ÈÇÆÁÆ±üì≠"> </el-table-column>
        <el-table-column prop="mobile" label="ÁîµËØùüì±"> </el-table-column>
        <el-table-column prop="role_name" label="ËßíËâ≤üßê"> </el-table-column>
        <el-table-column label="Áä∂ÊÄÅüëå">
          <template #default="scope">
            <el-switch
              v-model="scope.row.mg_state"
              active-color="#13ce66"
              inactive-color="#ff4949"
              @change="userStateChanged(scope.row)"
            >
            </el-switch>
          </template>
        </el-table-column>
        <el-table-column label="Êìç‰Ωúü§∑‚Äç‚ôÄÔ∏è" width="180px">
          <template #default="scope">
            <!-- ‰øÆÊîπ -->
            <el-button
              type="primary"
              icon="el-icon-edit"
              circle
              size="mini"
              @click="showEditDialog(scope.row.id)"
            ></el-button>
            <!-- Âà†Èô§ -->
            <el-button
              type="danger"
              icon="el-icon-delete"
              circle
              size="mini"
              @click="removeUserById(scope.row.id)"
            ></el-button>
            <!-- ÂàÜÈÖçËßíËâ≤ -->
            <el-tooltip
              effect="light"
              content="ÂàÜÈÖçËßíËâ≤"
              placement="top-start"
              :enterable="false"
            >
              <el-button
                type="warning"
                icon="el-icon-setting"
                circle
                size="mini"
              ></el-button>
            </el-tooltip>
          </template>
        </el-table-column>
      </el-table>
      <!-- ÂàÜÈ°µÂå∫Âüü -->
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="queryInfo.pagenum"
        :page-sizes="[1, 2, 5, 10]"
        :page-size="queryInfo.pagesize"
        layout="total, sizes, prev, pager, next, jumper"
        :total="total"
      >
      </el-pagination>
    </el-card>
    <!-- Ê∑ªÂä†Áî®Êà∑ÁöÑÂØπËØùÊ°ÜÁªÑ‰ª∂ -->
    <el-dialog
      title="Ê∑ªÂä†Áî®Êà∑"
      v-model="dialogVisible"
      :width="mobile ? '80%' : '50%'"
      @close="diaglogClose"
    >
      <!-- ÂØπËØùÊ°ÜÂÜÖÂÆπ‰∏ª‰ΩìÂå∫Âüü -->
      <el-form :model="addForm" :rules="addFormRules" ref="myForm">
        <el-form-item label="Áî®Êà∑Âêç" prop="username">
          <el-input v-model="addForm.username"></el-input>
        </el-form-item>
        <el-form-item label="ÂØÜÁ†Å" prop="password">
          <el-input v-model="addForm.password"></el-input>
        </el-form-item>
        <el-form-item label="ÈÇÆÁÆ±" prop="email">
          <el-input v-model="addForm.email"></el-input>
        </el-form-item>
        <el-form-item label="ÊâãÊú∫Âè∑" prop="mobile">
          <el-input v-model="addForm.mobile"></el-input>
        </el-form-item>
      </el-form>
      <!-- Â∫ïÈÉ®Âå∫Âüü -->
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="dialogVisible = false">Âèñ Ê∂à</el-button>
          <el-button type="primary" @click="addUser">Á°Æ ÂÆö</el-button>
        </span>
      </template>
    </el-dialog>
    <!-- ‰øÆÊîπÁî®Êà∑ÁöÑÂØπËØùÊ°Ü -->
    <el-dialog
      title="ÊèêÁ§∫"
      v-model="editDialogVisible"
      :width="mobile ? '80%' : '50%'"
      @close="editDialogClose"
    >
      <el-form
        :model="editForm"
        :rules="editFormRules"
        ref="myEditForm"
        label-width="70px"
      >
        <el-form-item label="Áî®Êà∑Âêç">
          <el-input v-model="editForm.username" disabled></el-input>
        </el-form-item>
        <el-form-item label="ÈÇÆÁÆ±" prop="email">
          <el-input v-model="editForm.email"></el-input>
        </el-form-item>
        <el-form-item label="ÊâãÊú∫Âè∑" prop="mobile">
          <el-input v-model="editForm.mobile"></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="editDialogVisible = false">Âèñ Ê∂à</el-button>
          <el-button type="primary" @click="editUserInfo">Á°Æ ÂÆö</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>


<script setup>
import { ElMessage, ElMessageBox } from "element-plus";
import { getCurrentInstance, onBeforeMount, ref, reactive, inject } from "vue";
const internalInstance = getCurrentInstance(); //ËÆ∞ÂæóÂºïÂÖ•getCurrentInstance
const axios = internalInstance.appContext.config.globalProperties.$http;

// Âà§Êñ≠ÊâãÊú∫Â±èÂπï
import checkScreen from "../../hooks/checkScreenSize.js";
const mobile = checkScreen();

// Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
// ================================
// Ëé∑ÂèñÁî®Êà∑ÂàóË°®ÁöÑÂèÇÊï∞ÂØπË±° pagenum ÂΩìÂâçÂú®Á¨¨Âá†È°µ pagesize:ÊòæÁ§∫ÁöÑÊù°Êï∞
const queryInfo = reactive({ query: "", pagenum: 1, pagesize: 2 });
// Áî®Êà∑‰ø°ÊÅØ
let userList = ref([]);
let total = ref(0);
async function getUserList() {
  const { data } = await axios.get("users", {
    params: queryInfo,
  });
  if (data.meta.status !== 200)
    return ElMessage({
      showClose: true,
      message: "Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•",
      type: "error",
    });

  userList.value = data.data.users;
  total.value = data.data.total;
}
onBeforeMount(getUserList);

// ÁõëÂê¨SwitchÂºÄÂÖ≥Áä∂ÊÄÅÁöÑÂèòÂåñ ‰øùÂ≠òÁî®Êà∑Áä∂ÊÄÅÁöÑÂèòÂåñ
// ==============================
// ÂèëÈÄÅputËØ∑Ê±Ç ËØ∑Ê±ÇË∑ØÂæÑÔºöusers/:uId/state/:type
async function userStateChanged(userInfo) {
  const { data } = await axios.put(
    `users/${userInfo.id}/state/${userInfo.mg_state}`
  );
  // Â¶ÇÊûúÁôªÂΩïÁä∂ÊÄÅ‰øÆÊîπÊàêÂäü
  if (data.meta.status !== 200) {
    // Âõ†‰∏∫Ê≤°Êúâ‰øÆÊîπÊàêÂäüÔºåÊâÄ‰ª•Á´ãÂàªÂ∞ÜÁä∂ÊÄÅÊîπÂõûÂéª
    userInfo.mg_state = !userInfo.mg_state;
    return ElMessage({
      showClose: true,
      message: "‰øÆÊîπÁî®Êà∑Áä∂ÊÄÅÂ§±Ë¥•",
      type: "error",
    });
  }
  ElMessage({
    showClose: true,
    message: "‰øÆÊîπÁî®Êà∑Áä∂ÊÄÅÊàêÂäü",
    type: "success",
  });
}

// ÂÆûÁé∞ÂàÜÈ°µÊïàÊûú
// ========================
//ÁõëÂê¨pagesizeÊîπÂèòÁöÑ‰∫ã‰ª∂ Â§ÑÁêÜÊØèÈ°µÊòæÁ§∫ÁöÑÊù°Êï∞ÂèòÂåñ
function handleSizeChange(newSize) {
  console.log(newSize);
  queryInfo.pagesize = newSize;
  // ÈáçÊñ∞ÂèëËµ∑ËØ∑Ê±Ç
  getUserList();
}
// ÁõëÂê¨È°µÁ†ÅÁöÑÂèòÂåñ
function handleCurrentChange(newPage) {
  queryInfo.pagenum = newPage;
  getUserList();
}

// Ê∑ªÂä†Áî®Êà∑ÂØπËØùÊ°ÜÂäüËÉΩ
// ============================
let dialogVisible = ref(false); // ÊéßÂà∂ÂØπËØùÊ°ÜÁöÑÊòæÁ§∫‰∏éÈöêËóè
let addForm = reactive({
  username: "",
  password: "",
  email: "",
  mobile: "",
}); // Ë°®ÂçïÊï∞ÊçÆ

// ÈÇÆÁÆ±È™åËØÅËßÑÂàô
const checkEmail = (rules, value, callback) => {
  const refEmail = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;
  // Ê†°È™åÊàêÂäü
  if (refEmail.test(value)) return callback();
  callback(new Error("ËØ∑ËæìÂÖ•ÂêàÊ≥ïÁöÑÈÇÆÁÆ±"));
};
// ÊâãÊú∫Âè∑È™åËØÅËßÑÂàô
const checkMobile = (rules, value, callback) => {
  const refMobile =
    /^(13[0-9]|14[5|7]|15[0|1|2|3|4|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])\d{8}$/;
  // Ê†°È™åÊàêÂäü
  if (refMobile.test(value)) return callback();
  callback(new Error("ËØ∑ËæìÂÖ•ÂêàÊ≥ïÁöÑÊâãÊú∫Âè∑Á†Å"));
};

//Ë°®ÂçïÈ™åËØÅËßÑÂàô
let addFormRules = reactive({
  username: [
    { required: true, message: "ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÁß∞", trigger: "blur" },
    { min: 3, max: 10, message: "Áî®Êà∑ÂêçÈïøÂ∫¶Âú® 3~10 ‰∏™Â≠óÁ¨¶", trigger: "blur" },
  ],
  password: [
    { required: true, message: "ËØ∑ËæìÂÖ•ÂØÜÁ†Å", trigger: "blur" },
    { min: 6, max: 16, message: "Áî®Êà∑ÂêçÈïøÂ∫¶Âú® 6~16 ‰∏™Â≠óÁ¨¶", trigger: "blur" },
  ],
  email: [
    { required: true, message: "ËØ∑ËæìÂÖ•ÈÇÆÁÆ±", trigger: "blur" },
    { validator: checkEmail, trigger: "blur" },
  ],
  mobile: [
    { required: true, message: "ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑", trigger: "blur" },
    { validator: checkMobile, trigger: "blur" },
  ],
});

// ÂØπËØùÊ°ÜÂÖ≥Èó≠ÔºåÈáçÁΩÆË°®Âçï
const myForm = ref(null);
function diaglogClose() {
  myForm.value.resetFields();
}

// Ê∑ªÂä†Áî®Êà∑ÂäüËÉΩ
//========================
function addUser() {
  myForm.value.validate(async (valid) => {
    if (!valid)
      return ElMessage({
        showClose: true,
        message: "ËØ∑Â°´ÂÜôÂêàÊ≥ïÁöÑ‰ø°ÊÅØ",
        type: "error",
      });
    // ÂèëËµ∑ËØ∑Ê±Ç
    let { data } = await axios.post("users", addForm);
    if (data.meta.status !== 201) {
      return ElMessage({
        showClose: true,
        message: "Ê∑ªÂä†Áî®Êà∑Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï",
        type: "error",
      });
    }
    ElMessage({
      showClose: true,
      message: "Ê∑ªÂä†Áî®Êà∑ÊàêÂäü",
      type: "success",
    });
    // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
    dialogVisible.value = false;
    // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
    getUserList();
  });
}

// Â±ïÁ§∫ÁºñËæëÁî®Êà∑ÁöÑÂØπËØùÊ°Ü
let editDialogVisible = ref(false);
let editForm = ref({});
let editFormRules = reactive({
  email: [
    { required: true, message: "ËØ∑ËæìÂÖ•ÂØÜÁ†Å", trigger: "blur" },
    { validator: checkEmail, trigger: "blur" },
  ],
  mobile: [
    { required: true, message: "ËØ∑ËæìÂÖ•ÂØÜÁ†Å", trigger: "blur" },
    { validator: checkMobile, trigger: "blur" },
  ],
});
async function showEditDialog(id) {
  editDialogVisible.value = true;
  const { data } = await axios.get("users/" + id);
  if (data.meta.status !== 200)
    return ElMessage({
      showClose: true,
      message: "Êü•ËØ¢Áî®Êà∑‰ø°ÊÅØÂ§±Ë¥•",
      type: "error",
    });
  editForm.value = data.data;
}

let myEditForm = ref(null);
// ÁõëÂê¨‰øÆÊîπÁî®Êà∑ÂØπËØùÊ°ÜÁöÑÂÖ≥Èó≠ÁöÑ‰∫ã‰ª∂
function editDialogClose() {
  myEditForm.value.resetFields();
}

// ‰øÆÊîπÁî®Êà∑‰ø°ÊÅØÂπ∂Êèê‰∫§
function editUserInfo() {
  myEditForm.value.validate(async (valid) => {
    if (!valid)
      return ElMessage({
        showClose: true,
        message: "ËØ∑Â°´ÂÜôÂêàÊ≥ïÁöÑ‰ø°ÊÅØ",
        type: "error",
      });
    let { data } = await axios.put("users/" + editForm.value.id, {
      email: editForm.value.email,
      mobile: editForm.value.mobile,
    });
    if (data.meta.status !== 200) {
      return ElMessage({
        showClose: true,
        message: "Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÂ§±Ë¥•",
        type: "error",
      });
    }
    // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
    editDialogVisible.value = false;
    ElMessage({
      showClose: true,
      message: "Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÊàêÂäü",
      type: "success",
    });
    // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
    getUserList();
  });
}

// Âà†Èô§Áî®Êà∑
async function removeUserById(id) {
  // ÂºπÁ™óÊèêÁ§∫Áî®Êà∑
  const confirmResult = await ElMessageBox.confirm(
    "Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ËØ•Áî®Êà∑, ÊòØÂê¶ÁªßÁª≠?",
    "ÊèêÁ§∫",
    {
      confirmButtonText: "Á°ÆÂÆö",
      cancelButtonText: "ÂèñÊ∂à",
      type: "warning",
    }
  ).catch((err) =>
    ElMessage({
      showClose: true,
      message: "ÂèñÊ∂àÂà†Èô§",
      type: "info",
    })
  );
  // Â¶ÇÊûúÁî®Êà∑Á°ÆËÆ§Âà†Èô§
  if (confirmResult === "confirm") {
    let { data } = await axios.delete("users/" + id);
    if (data.meta.status !== 200)
      return ElMessage({
        showClose: true,
        message: "Âà†Èô§Áî®Êà∑Â§±Ë¥•",
        type: "error",
      });

    ElMessage({
      showClose: true,
      message: "Âà†Èô§Áî®Êà∑ÊàêÂäü",
      type: "success",
    });
    // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
    getUserList();
  }
}
</script>


<style scoped>
.el-col {
  margin: 10px 0;
}
.el-table {
  margin-top: 15px;
  font-size: 12px;
}

.el-form {
  margin: 0;
  position: relative;
}
</style>